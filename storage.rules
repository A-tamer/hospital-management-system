// ============================================
// STORAGE SECURITY RULES - PRODUCTION READY
// ============================================
// Updated to require Firebase Authentication
// ============================================

rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // ==========================================
    // HELPER FUNCTIONS
    // ==========================================
    
    // Check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Check if file is a valid image
    function isImage() {
      return request.resource.contentType.matches('image/.*');
    }
    
    // Check if file is a PDF
    function isPDF() {
      return request.resource.contentType == 'application/pdf';
    }
    
    // Check if file size is within limit (10MB)
    function isValidSize() {
      return request.resource.size < 10 * 1024 * 1024;
    }
    
    // ==========================================
    // PATIENT FILES
    // ==========================================
    match /patients/{patientCode}/{folder}/{fileName} {
      // Only authenticated users can read patient files
      allow read: if isSignedIn();
      
      // Only authenticated users can upload files
      // Files must be images or PDFs and under 10MB
      allow write: if isSignedIn() 
                   && isValidSize()
                   && (isImage() || isPDF());
      
      // Only authenticated users can delete files
      allow delete: if isSignedIn();
    }
    
    // ==========================================
    // DENY ALL OTHER PATHS
    // ==========================================
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}

// ============================================
// VALIDATION RULES EXPLAINED:
// ============================================
// 1. All operations require Firebase Authentication
// 2. Max file size: 10MB (10 * 1024 * 1024 bytes)
// 3. Allowed file types:
//    - Images: JPEG, PNG, WebP, GIF
//    - Documents: PDF only
// 4. Folder structure:
//    /patients/{patientCode}/personal/{filename}
//    /patients/{patientCode}/surgery/{filename}
//    /patients/{patientCode}/radiology/{filename}
//    /patients/{patientCode}/lab/{filename}
// ============================================

// ============================================
// SECURITY NOTES:
// ============================================
// 1. Patient files are now protected
// 2. Only authenticated users can access files
// 3. File size and type restrictions prevent abuse
// 4. Medical images and documents are secure
// ============================================

// ============================================
// DEPLOYMENT INSTRUCTIONS:
// ============================================
// 1. Go to Firebase Console
// 2. Navigate to Storage â†’ Rules
// 3. Copy and paste this entire file
// 4. Click "Publish"
// 5. Test file uploads to ensure they work
// ============================================
